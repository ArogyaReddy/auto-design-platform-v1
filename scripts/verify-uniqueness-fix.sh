#!/bin/bash

# Element AI Extractor - UNIQUENESS VALIDATION Fix Verification
# This script tests the critical fix for non-unique selectors

echo "üéØ Element AI Extractor - UNIQUENESS FIX VERIFICATION"
echo "====================================================="
echo ""

# Check if extension files exist
if [ ! -f "bots/elementsExtractor/popup.js" ]; then
    echo "‚ùå ERROR: Extension files not found!"
    echo "   Make sure you're running this from the ElementsExtractorV1 directory"
    exit 1
fi

echo "‚úÖ Extension files found"
echo ""

echo "üî• CRITICAL ISSUE FIXED:"
echo "========================"
echo ""
echo "‚ùå BEFORE: h3:nth-of-type(1) ‚Üí Found 2 elements (AUTOMATION FAILS!)"
echo "‚úÖ AFTER:  Each element gets a UNIQUE selector that matches exactly 1 element"
echo ""

echo "üîß TECHNICAL FIXES IMPLEMENTED:"
echo "==============================="
echo ""
echo "‚úÖ Enhanced validateSelector() function:"
echo "   - Now checks testElements.length === 1 (MUST be unique)"
echo "   - Validates that selector targets the correct element"
echo "   - Rejects any selector that matches multiple elements"
echo ""
echo "‚úÖ Updated generateIdSelector() function:"
echo "   - Takes targetElement parameter for validation"
echo "   - Tests both #id and [id=\"...\"] formats"
echo "   - Returns only validated, unique selectors"
echo ""
echo "‚úÖ Enhanced getBestLocator() function:"
echo "   - All selector types now validated for uniqueness"
echo "   - Fallback strategies when primary selectors aren't unique"
echo "   - Ultimate path-based selector generation for guaranteed uniqueness"
echo ""
echo "‚úÖ Fixed getUniqueCssSelector() function:"
echo "   - Path building with uniqueness validation at each step"
echo "   - Final validation before returning any selector"
echo "   - Proper nth-of-type calculation with validation"
echo ""

echo "üß™ TESTING INSTRUCTIONS:"
echo "========================"
echo ""
echo "STEP 1: Load the Extension"
echo "   - Chrome ‚Üí chrome://extensions/"
echo "   - Developer mode ‚Üí Load unpacked"
echo "   - Select: $(pwd)/bots/elementsExtractor"
echo ""

echo "STEP 2: Open Test Pages"
echo "   üìã Main Test: file://$(pwd)/tests/uniqueness-validation-test.html"
echo "   üìã Compatibility: file://$(pwd)/tests/devtools-compatibility-test.html"
echo ""

echo "STEP 3: Test the Critical Fix"
echo "   - Open DevTools (F12) ‚Üí Console"
echo "   - Run: document.querySelectorAll('h3:nth-of-type(1)').length"
echo "   - If result is > 1, then h3:nth-of-type(1) is NOT unique!"
echo "   - Element AI Extractor should NOT generate this selector anymore"
echo ""

echo "STEP 4: Verify Extension Behavior"
echo "   - Click Element AI Extractor icon"
echo "   - Click 'Extract Elements' or 'Start Inspecting'"
echo "   - Hover over any H3 element"
echo "   - Copy the generated locator"
echo "   - Paste in DevTools: document.querySelectorAll('COPIED_LOCATOR').length"
echo "   - Should ALWAYS return exactly 1"
echo ""

echo "üéØ SUCCESS CRITERIA:"
echo "==================="
echo ""
echo "‚úÖ NO generated selector should match more than 1 element"
echo "‚úÖ Complex IDs should use [id=\"...\"] format and work in DevTools"
echo "‚úÖ Navigation elements should use .class[href=\"...\"] format"
echo "‚úÖ All selectors should pass: document.querySelector('selector') !== null"
echo "‚úÖ All selectors should pass: document.querySelectorAll('selector').length === 1"
echo ""

echo "üö® WHAT TO LOOK FOR:"
echo "===================="
echo ""
echo "‚ùå BAD: Extension generates h3:nth-of-type(1) when multiple H3s exist"
echo "‚úÖ GOOD: Extension generates specific path like 'div.test-section h3:nth-of-type(1)'"
echo ""
echo "‚ùå BAD: Extension generates selectors that match multiple elements"
echo "‚úÖ GOOD: Extension validates and only returns unique selectors"
echo ""
echo "‚ùå BAD: DevTools console shows 'Invalid selector' errors"
echo "‚úÖ GOOD: All copied selectors work perfectly in DevTools"
echo ""

echo "üìã QUICK CONSOLE TEST:"
echo "====================="
echo ""
echo "After loading the test page, run these in DevTools console:"
echo ""
echo "// Test the problem case"
echo "console.log('h3 count:', document.querySelectorAll('h3:nth-of-type(1)').length);"
echo ""
echo "// Test fixed selectors"
echo "console.log('Simple ID:', document.querySelectorAll('#simple-input').length);"
echo "console.log('Complex ID:', document.querySelectorAll('[id=\"complex-id.with.dots\"]').length);"
echo "console.log('Navigation:', document.querySelectorAll('.nav-link[href=\"#home\"]').length);"
echo ""
echo "// All results should be exactly 1 for unique selectors"
echo ""

echo "üéâ SUMMARY:"
echo "==========="
echo ""
echo "The Element AI Extractor now:"
echo "‚úÖ Generates ONLY unique selectors (exactly 1 match each)"
echo "‚úÖ Works reliably in automation frameworks"
echo "‚úÖ Validates all selectors before returning them"
echo "‚úÖ Provides fallback strategies for guaranteed uniqueness"
echo "‚úÖ Supports complex CSS scenarios and DevTools compatibility"
echo ""
echo "üöÄ No more failed automation due to non-unique selectors!"
echo "   The Element AI Extractor is now bulletproof! üõ°Ô∏è"
